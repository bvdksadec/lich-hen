<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <title>Bvƒëk Sa ƒê√©c</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="./LOGO-SD.ico">

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --brand: #0e5bce;
      --brand-2: #0e5bce;
      --brand-light: #e4eeff;
      --bg: #f6f9ff;
      --card: #ffffffd9;
      --border: #d7e3f4;
      --text: #12263a;
      --muted: #6b7a90;
      --thead: #0e5bce;
      --thead-border: #c6d6f3;
      --row-hover: #eef5ff;
    }

    html,
    body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
    }

    body {
      font-family: system-ui, Roboto, Segoe UI;
      font-size: 16px;
    }

    .container-xl {
      max-width: 90vw;
    }

    .nav-hero {
      background: linear-gradient(135deg, #064eb9, #2f77ce);
      box-shadow: 0 5px 20px #0044aa66;
      color: #fff;
    }

    .app-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 28px rgb(0 0 0 / 0.08);
    }

    .btn-pill {
      border-radius: 999px;
      padding: 4px 12px;
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      background: #0e5bce;
      color: #fff;
    }

    .btn {
      border-radius: 999px;
    }

    .btn-soft {
      background: var(--brand-light);
      border: 1px solid var(--border);
      color: var(--brand);
    }

    .btn-soft:hover {
      background: #d6e7ff;
    }

    .toolbar .form-control {
      height: 42px;
    }

    input.form-control {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
    }

    .search-input {
      max-width: 340px;
      margin-left: auto;
    }

    .table-wrap {
      overflow: auto;
      max-height: 450px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
    }

    table {
      color: var(--text);
      width: 100%;
      table-layout: fixed;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--thead) !important;
      border-bottom: 1px solid var(--thead-border) !important;
      color: #fff !important;
      font-weight: 700;
      letter-spacing: .2px;
      white-space: nowrap;
    }

    tbody tr:hover {
      background: var(--row-hover);
    }

    th,
    td {
      vertical-align: middle;
    }

    .table td,
    .table th {
      padding: .55rem .75rem;
    }

    td.nowrap {
      white-space: nowrap;
    }

    .table th.col-idx,
    .table td.col-idx {
      width: 40px;
      text-align: center;
    }

    .table th.col-sott,
    .table td.col-sott {
      width: 70px;
      text-align: center;
    }

    .table th.col-hotten,
    .table td.col-hotten {
      width: 220px;
    }

    .symptom-cell {
      white-space: normal;
      word-break: break-word;
      font-size: 16px;
      line-height: 1.35;
    }

    .badge-status {
      border-radius: 999px;
      padding: .25rem .6rem;
      border: 1px solid transparent;
      font-weight: 600;
      white-space: nowrap;
      font-size: 16px;
    }

    .badge-wait {
      background: #fff3d9;
      color: #9a6a00;
      border-color: #ffdf97;
    }

    .badge-ok {
      background: #e6f7ed;
      color: #0f6c3f;
      border-color: #c6ead5;
    }

    .badge-cancel {
      background: #ffeef0;
      color: #a5162a;
      border-color: #ffd6db;
    }

    .status {
      color: var(--muted);
    }

    .count-chip {
      font-variant-numeric: tabular-nums;
      background: #eef5ff;
      color: #0a3a92;
      border: 1px solid #c9dbff;
      border-radius: 10px;
      padding: .35rem .65rem;
    }

    .progressbar {
      height: 3px;
      background: #dce8ff;
      border-radius: 20px;
      overflow: hidden;
    }

    .progressbar>span {
      display: block;
      width: 35%;
      height: 100%;
      background: linear-gradient(90deg, #6bb6ff, #0d6efd, #6bb6ff);
      animation: indet 1.2s infinite linear;
    }

    @keyframes indet {
      0% {
        margin-left: -35%;
      }

      100% {
        margin-left: 100%;
      }
    }

    .footerbar {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-top: 1px solid var(--border);
      background: #fafcffb8;
      border-radius: 12px;
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    @media (max-width:576px) {
      .toolbar-right {
        overflow-x: auto;
        white-space: nowrap;
      }

      .toolbar-right .btn {
        padding: 8px 10px;
      }

      .toolbar-right .btn .btn-text {
        display: none;
      }

      .toolbar-right .count-chip {
        flex: 0 0 auto;
      }

      .badge-status {
        font-size: 14px;
        padding: .2rem .45rem;
      }

      .search-input {
        max-width: 100%;
        margin-left: 0;
      }
    }

    .table-responsive-cards thead {
      display: table-header-group;
    }

    @media (max-width:768px) {
      .table-responsive-cards thead {
        display: none;
      }

      .table-responsive-cards tbody {
        display: block;
      }

      .table-responsive-cards tbody tr {
        display: block;
        margin: 10px 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, .04);
      }

      .table-responsive-cards tbody tr:nth-child(even) {
        background: #fff;
      }

      .table-responsive-cards tbody td {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 8px;
        padding: .6rem .75rem;
        border: 0 !important;
        white-space: normal;
      }

      .table-responsive-cards tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #0a2a66;
      }

      .table-responsive-cards tbody td.actions {
        grid-template-columns: 120px auto;
        align-items: center;
      }

      .table-responsive-cards tbody td.actions .btn {
        width: auto;
        display: inline-flex;
        justify-content: center;
      }
    }

    /* ===== Modal ki·ªÉu SweetAlert ‚Äì ch·ªânh theo y√™u c·∫ßu ===== */
    #confirmModal .modal-dialog {
      max-width: 430px;
    }

    .modal-content.confirm-modal {
      border-radius: 20px;
      border: 1px solid #d7e3ff;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.35);
      padding: 24px 26px 20px;
      text-align: center;
      background:
        radial-gradient(circle at top, #eff4ff 0, #ffffff 55%),
        radial-gradient(circle at bottom, #e0edff 0, #ffffff 45%);
    }

    .swal-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 3px solid #c7ddff;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 14px;
      background: radial-gradient(circle at 30% 30%, #ffffff, #e3edff);
      /* shadow nh·∫π h∆°n */
      box-shadow:
        0 0 0 4px rgba(191, 219, 254, 0.4),
        0 8px 18px rgba(37, 99, 235, 0.25);
      color: #0e5bce;
      font-size: 30px;
    }

    .swal-title {
      font-size: 22px;
      font-weight: 750;
      margin-bottom: 8px;
      color: #0e5bce; /* ti√™u ƒë·ªÅ c√≥ m√†u */
    }

    .swal-patient {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .swal-detail {
      font-size: 16px;
      color: #374151;
      margin-bottom: 10px;
    }

    .swal-hint {
      font-size: 14px;
      color: #6b7280;
    }

    .swal-hint b {
      color: #0e5bce;
    }

    .swal-buttons {
      margin-top: 18px;
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .swal-buttons .btn {
      min-width: 120px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 15px;
      display: inline-flex;
      align-items: center;
      justify-content: center; /* ch·ªØ cƒÉn gi·ªØa */
    }

    .swal-buttons .btn-cancel {
      background: #e5e7eb;
      color: #374151;
      border: none;
    }

    .swal-buttons .btn-cancel:hover {
      background: #d1d5db;
    }

    .swal-buttons .btn-confirm {
      background: #0e5bce;
      border: none;
      color: #fff;
    }

    .swal-buttons .btn-confirm:hover {
      background: #0b4aa8;
    }

    @media (max-width: 576px) {
      .modal-content.confirm-modal {
        padding: 20px 14px 16px;
      }

      .swal-buttons {
        flex-direction: column-reverse;
      }

      .swal-buttons .btn {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="nav-hero py-2">
    <div class="container-xl d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <img src="./LOGO-SD.png" width="40" style="border-radius:4px" alt="">
        <div class="fw-semibold fs-5">Danh s√°ch ƒë·∫∑t l·ªãch online</div>
      </div>
      <span class="badge bg-light text-primary fw-normal p-2">
        <i class="bi bi-shield-check fs-5"></i>
      </span>
    </div>
  </div>

  <div class="container-xl my-4">
    <div class="app-card p-3 p-md-4">
      <!-- Toolbar -->
      <div class="d-flex flex-column flex-lg-row align-items-lg-center toolbar" style="gap:12px">
        <div class="d-flex align-items-center gap-2 flex-shrink-0">
          <span class="text-secondary"><i class="bi bi-calendar-date fs-5 text-primary"></i></span>
          <input id="dateInput" type="date" class="form-control" style="width:220px">
        </div>

        <div class="d-flex align-items-center gap-2 mt-2 mt-lg-0 flex-shrink-0 toolbar-right">
          <button id="btnFetch" class="btn btn-pill">
            <i class="bi bi-download"></i><span class="btn-text"> L·∫•y d·ªØ li·ªáu</span>
          </button>
          <button id="btnCsv" class="btn btn-soft btn-pill" disabled>
            <i class="bi bi-file-earmark-spreadsheet"></i><span class="btn-text"> T·∫£i CSV</span>
          </button>

          <span class="status small d-flex align-items-center">
            <i class="bi bi-activity me-1"></i><span id="statusText">S·∫µn s√†ng</span>
          </span>
          <span class="count-chip">
            <i class="bi bi-table me-1"></i><span id="countRows">0</span> d√≤ng
          </span>
        </div>

        <div class="mt-2 mt-lg-0 flex-grow-1">
          <div class="input-group search-input">
            <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
            <input id="searchInput" type="text" class="form-control" placeholder="T√¨m theo t√™n ho·∫∑c m√£ th·∫ª...">
          </div>
        </div>
      </div>

      <div id="progress" class="progressbar mt-3 d-none"><span></span></div>

      <div class="table-wrap mt-3">
        <table class="table table-sm table-striped align-middle mb-0 table-responsive-cards">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="empty" class="text-center text-secondary py-4 d-none">
          üìÇ Ch∆∞a c√≥ d·ªØ li·ªáu cho ng√†y ƒë√£ ch·ªçn.
        </div>
      </div>

      <div class="footerbar mt-3">
        <div class="small text-secondary">
          <i class="bi bi-info-circle me-1"></i>
          B·∫•m ‚ÄúX√°c nh·∫≠n‚Äù v·ªõi d√≤ng tr·∫°ng th√°i <b>Ch·ªù x√°c nh·∫≠n</b>.
        </div>
        <div class="d-flex gap-2">
          <button id="btnTop" class="btn btn-soft btn-sm btn-pill"><i class="bi bi-arrow-up"></i> L√™n ƒë·∫ßu</button>
          <button id="btnBottom" class="btn btn-soft btn-sm btn-pill"><i class="bi bi-arrow-down"></i> Cu·ªëi b·∫£ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL X√ÅC NH·∫¨N -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content confirm-modal">
        <div class="swal-icon">
          <i class="bi bi-check2"></i>
        </div>
        <div class="swal-title">X√°c nh·∫≠n l·ªãch kh√°m?</div>

        <!-- ƒê√É B·ªé D√íNG m√¥ t·∫£ ‚ÄúB·∫°n s·∫Øp x√°c nh·∫≠n l·ªãch kh√°m cho b·ªánh nh√¢n‚Ä¶‚Äù -->
        <div class="swal-patient" id="confirmPatientName"></div>
        <div class="swal-detail" id="confirmText"></div>
        <div class="swal-hint">
          Sau khi x√°c nh·∫≠n, l·ªãch s·∫Ω chuy·ªÉn sang tr·∫°ng th√°i <b>ƒê√£ x√°c nh·∫≠n</b>.
        </div>

        <div class="swal-buttons">
          <button type="button" class="btn btn-cancel btn-pill" data-bs-dismiss="modal">
            H·ªßy
          </button>
          <button type="button" class="btn btn-confirm btn-pill" id="confirmOkBtn">
            X√°c nh·∫≠n
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = "https://quoc.shop/public/api";
    const SECRET_KEY = "BVDKSADEC@2025";

    const dateInput = document.getElementById("dateInput");
    const searchInput = document.getElementById("searchInput");
    const btnFetch = document.getElementById("btnFetch");
    const btnCsv = document.getElementById("btnCsv");
    const theadEl = document.getElementById("thead");
    const tbodyEl = document.getElementById("tbody");
    const statusText = document.getElementById("statusText");
    const countRows = document.getElementById("countRows");
    const progress = document.getElementById("progress");
    const emptyEl = document.getElementById("empty");
    const btnTop = document.getElementById("btnTop");
    const btnBottom = document.getElementById("btnBottom");

    const confirmTextEl = document.getElementById("confirmText");
    const confirmPatientNameEl = document.getElementById("confirmPatientName");
    const confirmOkBtn = document.getElementById("confirmOkBtn");
    let confirmModal;
    let pendingRow = null;
    let pendingTr = null;

    let fullRows = [];
    let viewRows = [];

    dateInput.value = new Date().toISOString().slice(0, 10);

    window.addEventListener("DOMContentLoaded", () => {
      const modalEl = document.getElementById("confirmModal");
      if (modalEl) {
        confirmModal = new bootstrap.Modal(modalEl);
      }
      btnFetch.click();
    });

    dateInput.addEventListener("change", () => {
      if (dateInput.value) {
        btnFetch.click();
      }
    });

    function setLoading(on) {
      progress.classList.toggle("d-none", !on);
      statusText.textContent = on ? "ƒêang t·∫£i‚Ä¶" : "S·∫µn s√†ng";
    }
    function showEmpty(show) { emptyEl.classList.toggle("d-none", !show); }

    function autoColumns(rows) {
      const k = new Set();
      rows.forEach(r => {
        Object.keys(r || {}).forEach(x => k.add(x));
      });
      return [...k];
    }

    function toVNDate(s) {
      if (!s) return "";
      try {
        if (/^\d{4}-\d{2}-\d{2}T/.test(s)) {
          const d = new Date(s);
          if (!isNaN(d)) return d.toLocaleDateString("vi-VN");
        }
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
          const [y, m, d] = s.split("-");
          return [d, m, y].join("/");
        }
        if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) return s;
        const d = new Date(s);
        if (!isNaN(d)) return d.toLocaleDateString("vi-VN");
      } catch (_) { }
      return String(s);
    }

    const COL_LABELS = {
      MaThe: "M√£ th·∫ª",
      HoTen: "H·ªç t√™n",
      DichVu: "D·ªãch v·ª•",
      TrieuChung: "Tri·ªáu ch·ª©ng",
      NgaySinh: "Ng√†y sinh",
      SoTT: "S·ªë TT",
      Ngay: "Ng√†y",
      TrangThai: "Tr·∫°ng th√°i"
    };

    function statusBadge(v) {
      const x = Number(v);
      if (x === 0) return `<span class="badge-status badge-cancel"><i class="bi bi-x-circle me-1"></i>ƒê√£ h·ªßy</span>`;
      if (x === 1) return `<span class="badge-status badge-wait"><i class="bi bi-hourglass-split me-1"></i>Ch·ªù x√°c nh·∫≠n</span>`;
      if (x === 2) return `<span class="badge-status badge-ok"><i class="bi bi-check-circle me-1"></i>ƒê√£ x√°c nh·∫≠n</span>`;
      return `<span class="badge bg-secondary">N/A</span>`;
    }

    const BASE_COL_ORDER = ["MaThe", "HoTen", "DichVu", "TrieuChung", "NgaySinh", "SoTT", "Ngay", "TrangThai"];

    function getFinalColumns(rows) {
      const cols = autoColumns(rows);
      const base = BASE_COL_ORDER;
      const extras = cols.filter(
        (c) => !base.includes(c) && !String(c).startsWith("_")
      );
      return [
        ...base.filter((c) => cols.includes(c)),
        ...extras.sort()
      ];
    }

    async function apiGet(url) {
      const res = await fetch(url, {
        method: "GET",
        headers: {
          "X-SECRET-KEY": SECRET_KEY,
          "Accept": "application/json"
        }
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    async function apiPatch(url, payload) {
      const res = await fetch(url, {
        method: "PATCH",
        headers: {
          "X-SECRET-KEY": SECRET_KEY,
          "Accept": "application/json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload || {})
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    async function fetchData(ngay) {
      const url = `${API_BASE}/dat-lich/ngay/${encodeURIComponent(ngay)}`;
      return apiGet(url);
    }

    async function updateStatusPATCH(id, trangThai) {
      const url = `${API_BASE}/dat-lich/${id}/status`;
      return apiPatch(url, { trang_thai: trangThai });
    }

    function mapRecordToRow(rec) {
      return {
        _id: rec.id,
        MaThe: rec.ma_the || "",
        HoTen: rec.ho_ten || "",
        DichVu: rec.dich_vu || "",
        TrieuChung: rec.trieu_chung || "",
        NgaySinh: rec.ngay_sinh || "",
        SoTT: rec.so_tt || "",
        Ngay: rec.ngay_dat || "",
        TrangThai: rec.trang_thai ?? 1
      };
    }

    function renderTable(rows) {
      theadEl.innerHTML = "";
      tbodyEl.innerHTML = "";

      if (!rows || !rows.length) {
        btnCsv.disabled = true;
        countRows.textContent = "0";
        showEmpty(true);
        return;
      }
      showEmpty(false);

      const finalCols = getFinalColumns(rows);

      const trh = document.createElement("tr");

      const thIdx = document.createElement("th");
      thIdx.textContent = "#";
      thIdx.classList.add("col-idx");
      trh.appendChild(thIdx);

      finalCols.forEach((c) => {
        const th = document.createElement("th");
        th.textContent = COL_LABELS[c] || c;
        if (c === "HoTen") th.classList.add("col-hotten");
        if (c === "SoTT") th.classList.add("col-sott");
        trh.appendChild(th);
      });

      const thAct = document.createElement("th");
      thAct.textContent = "H√†nh ƒë·ªông";
      trh.appendChild(thAct);

      theadEl.appendChild(trh);

      rows.forEach((r, i) => {
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.textContent = i + 1;
        tdIndex.setAttribute("data-label", "#");
        tdIndex.classList.add("col-idx");
        tr.appendChild(tdIndex);

        finalCols.forEach((c) => {
          const td = document.createElement("td");
          td.setAttribute("data-label", COL_LABELS[c] || c);

          if (c === "HoTen") td.classList.add("col-hotten");
          if (c === "SoTT") td.classList.add("col-sott");

          if (c === "TrangThai") {
            td.innerHTML = statusBadge(r[c]);
          } else if (c === "NgaySinh" || c === "Ngay") {
            td.innerHTML = `<span class="nowrap">${toVNDate(r[c])}</span>`;
          } else if (c === "TrieuChung") {
            td.classList.add("symptom-cell");
            td.textContent = r[c] ?? "";
          } else {
            td.textContent = r[c] ?? "";
          }

          tr.appendChild(td);
        });

        const tdAct = document.createElement("td");
        tdAct.className = "actions";
        tdAct.setAttribute("data-label", "H√†nh ƒë·ªông");
        if (Number(r.TrangThai) === 1) {
          const btn = document.createElement("button");
          btn.className = "btn btn-success";
          btn.innerHTML = `<i class="bi bi-check2-square"></i> <span class="btn-text">X√°c nh·∫≠n</span>`;
          btn.onclick = () => confirmRow(r, tr);
          tdAct.appendChild(btn);
        } else {
          tdAct.innerHTML = `<span class="text-secondary">‚Äî</span>`;
        }
        tr.appendChild(tdAct);

        tbodyEl.appendChild(tr);
      });

      btnCsv.disabled = false;
      countRows.textContent = rows.length.toLocaleString("vi-VN");
    }

    function normalizeVN(s) {
      return (s || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }
    function applySearch() {
      const q = normalizeVN(searchInput.value.trim());
      if (!q) {
        viewRows = fullRows.slice();
        renderTable(viewRows);
        return;
      }
      viewRows = fullRows.filter(r => {
        const name = normalizeVN(r.HoTen);
        const card = normalizeVN(r.MaThe);
        return name.includes(q) || card.includes(q);
      });
      renderTable(viewRows);
    }
    function debounce(fn, ms) {
      let t;
      return (...a) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...a), ms);
      };
    }
    const onSearchDebounced = debounce(applySearch, 150);

    async function doConfirmRow(row, trEl) {
      const headers = [...document.querySelectorAll("#thead th")].map(th => th.textContent.trim());
      const idxTrangThai = headers.findIndex(h => h === "Tr·∫°ng th√°i");
      const cells = trEl.querySelectorAll("td");

      const old = row.TrangThai;
      row.TrangThai = 2;
      if (idxTrangThai > -1) cells[idxTrangThai].innerHTML = statusBadge(2);
      cells[cells.length - 1].innerHTML = `<span class="text-secondary">‚Äî</span>`;

      try {
        const resp = await updateStatusPATCH(row._id, 2);
        if (!resp?.success) {
          throw new Error(resp?.message || "Update failed");
        }
        const idx = fullRows.findIndex(x => x._id === row._id);
        if (idx > -1) fullRows[idx].TrangThai = 2;
      } catch (e) {
        row.TrangThai = old;
        if (idxTrangThai > -1) cells[idxTrangThai].innerHTML = statusBadge(old);
        if (Number(old) === 1) {
          const btn = document.createElement("button");
          btn.className = "btn btn-success btn-sm";
          btn.innerHTML = `<i class="bi bi-check2-square"></i> <span class="btn-text">X√°c nh·∫≠n</span>`;
          btn.onclick = () => confirmRow(row, trEl);
          cells[cells.length - 1].innerHTML = "";
          cells[cells.length - 1].appendChild(btn);
        } else {
          cells[cells.length - 1].innerHTML = `<span class="text-secondary">‚Äî</span>`;
        }
        alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + (e.message || e));
      }
    }

    function confirmRow(row, trEl) {
      pendingRow = row;
      pendingTr = trEl;

      if (confirmPatientNameEl) {
        confirmPatientNameEl.textContent = row.HoTen || "(Ch∆∞a c√≥ t√™n)";
      }
      if (confirmTextEl) {
        confirmTextEl.textContent = `S·ªë TT ${row.SoTT || ""} - M√£ th·∫ª ${row.MaThe || ""}.`;
      }

      if (confirmModal) {
        confirmModal.show();
      } else {
        if (window.confirm(`X√°c nh·∫≠n S·ªë TT ${row.SoTT} (M√£ th·∫ª ${row.MaThe})?`)) {
          doConfirmRow(row, trEl);
        }
      }
    }

    if (confirmOkBtn) {
      confirmOkBtn.addEventListener("click", async () => {
        if (!pendingRow || !pendingTr) return;
        await doConfirmRow(pendingRow, pendingTr);
        if (confirmModal) confirmModal.hide();
        pendingRow = null;
        pendingTr = null;
      });
    }

    btnFetch.onclick = async () => {
      const ngay = dateInput.value;
      if (!ngay) return alert("Ch·ªçn ng√†y");
      setLoading(true);
      try {
        const json = await fetchData(ngay);
        const arr = Array.isArray(json?.data) ? json.data : (Array.isArray(json) ? json : []);
        fullRows = arr.map(mapRecordToRow);
        viewRows = fullRows.slice();
        renderTable(viewRows);
        statusText.textContent = "Ho√†n t·∫•t ‚úì";
        applySearch();
      } catch (e) {
        fullRows = [];
        viewRows = [];
        renderTable(viewRows);
        statusText.textContent = "L·ªói";
        alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu: " + (e.message || e));
      } finally {
        setLoading(false);
      }
    };

    searchInput.addEventListener("input", onSearchDebounced);

    btnCsv.onclick = () => {
      if (!viewRows || !viewRows.length) return;

      const finalCols = getFinalColumns(viewRows);

      const esc = (s) => {
        s = s == null ? "" : String(s);
        return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
      };

      const head = ["STT", ...finalCols.map((c) => COL_LABELS[c] || c)].join(",");

      const body = viewRows
        .map((r, i) => {
          const values = finalCols.map((c) => {
            if (c === "TrangThai") {
              const x = Number(r[c]);
              return x === 0
                ? "ƒê√£ h·ªßy"
                : x === 1
                  ? "Ch·ªù x√°c nh·∫≠n"
                  : x === 2
                    ? "ƒê√£ x√°c nh·∫≠n"
                    : "";
            }
            if (c === "NgaySinh" || c === "Ngay") return toVNDate(r[c]);
            return r[c] ?? "";
          });
          return [i + 1, ...values.map(esc)].join(",");
        })
        .join("\n");

      const blob = new Blob(["\uFEFF" + head + "\n" + body], {
        type: "text/csv;charset=utf-8",
      });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `data_${dateInput.value}.csv`;
      a.click();
    };

    btnTop.onclick = () => document.querySelector(".table-wrap").scrollTo({ top: 0, behavior: "smooth" });
    btnBottom.onclick = () => {
      const w = document.querySelector(".table-wrap");
      w.scrollTo({ top: w.scrollHeight, behavior: "smooth" });
    };
  </script>
</body>

</html>
